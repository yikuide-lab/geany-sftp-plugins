name: Build

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, ubuntu-22.04, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config \
            libgtk-3-dev libssh2-1-dev libglib2.0-dev libjson-glib-dev
          # Install geany dev package (name varies by version)
          sudo apt-get install -y geany libgeany-dev 2>/dev/null \
            || sudo apt-get install -y geany geany-dev 2>/dev/null \
            || {
              # Fallback: install geany and build headers from source
              sudo apt-get install -y geany intltool libvte-2.91-dev
              GEANY_VER=$(dpkg -s geany | grep ^Version | cut -d' ' -f2 | cut -d- -f1)
              cd /tmp
              wget -q "https://download.geany.org/geany-${GEANY_VER}.tar.gz" \
                || wget -q "https://download.geany.org/geany-${GEANY_VER}.tar.bz2" -O geany-src.tar.bz2
              tar xf geany-*.tar.* 2>/dev/null
              cd geany-*/
              ./configure --prefix=/usr >/dev/null 2>&1
              sudo make install-includeHEADERS install-pkgconfigDATA >/dev/null 2>&1 \
                || sudo cp -r src/*.h /usr/include/geany/ 2>/dev/null
            }

      - name: Install dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew install geany gtk+3 libssh2 glib json-glib pkg-config

      - name: Verify pkg-config
        run: |
          pkg-config --cflags geany gtk+-3.0 libssh2 json-glib-1.0

      - name: Build
        run: make

      - name: Check binary
        run: file sftp.*
